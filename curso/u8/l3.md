---
layout: blog
tittle: OpenStack. Redes.
menu:
  - Unidad 8
---

## Nivel de red (L3)

### Reglas del grupo de seguridad

Como explicamos brevemente en la sección anterior, las reglas de seguridad se
aplican a cada instancia en la interfaz de red que la conecta con el bridge
linux.

Comprobamos las reglas de iptables que se han creado en el nodo de computación
al levantar la instancia test (b079c24c-8386-47db-a730-35b3a99419e8), en este
caso se crean reglas utilizando sólo los 10 primeros caracteres del uuid: 

	# iptables -S |grep b079c24c-8 
	-N neutron-openvswi-ib079c24c-8
	-N neutron-openvswi-ob079c24c-8
	-N neutron-openvswi-sb079c24c-8
	-A neutron-openvswi-FORWARD -m physdev --physdev-out tapb079c24c-83 --physdev-is-bridged -j neutron-openvswi-sg-chain 
	-A neutron-openvswi-FORWARD -m physdev --physdev-in tapb079c24c-83 --physdev-is-bridged -j neutron-openvswi-sg-chain 
	-A neutron-openvswi-INPUT -m physdev --physdev-in tapb079c24c-83 --physdev-is-bridged -j neutron-openvswi-ob079c24c-8 
	-A neutron-openvswi-ib079c24c-8 -m state --state INVALID -j DROP 
	-A neutron-openvswi-ib079c24c-8 -m state --state RELATED,ESTABLISHED -j RETURN 
	-A neutron-openvswi-ib079c24c-8 -s 10.0.0.3/32 -p udp -m udp --sport 67 --dport 68 -j RETURN 
	-A neutron-openvswi-ib079c24c-8 -j neutron-openvswi-sg-fallback 
	-A neutron-openvswi-ob079c24c-8 -p udp -m udp --sport 68 --dport 67 -j RETURN 
	-A neutron-openvswi-ob079c24c-8 -j neutron-openvswi-sb079c24c-8 
	-A neutron-openvswi-ob079c24c-8 -p udp -m udp --sport 67 --dport 68 -j DROP 
	-A neutron-openvswi-ob079c24c-8 -m state --state INVALID -j DROP 
	-A neutron-openvswi-ob079c24c-8 -m state --state RELATED,ESTABLISHED -j RETURN 
	-A neutron-openvswi-ob079c24c-8 -j neutron-openvswi-sg-fallback 
	-A neutron-openvswi-sb079c24c-8 -s 10.0.0.2/32 -m mac --mac-source FA:16:3E:79:3B:AC -j RETURN 
	-A neutron-openvswi-sb079c24c-8 -j DROP 
	-A neutron-openvswi-sg-chain -m physdev --physdev-out tapb079c24c-83 --physdev-is-bridged -j neutron-openvswi-ib079c24c-8 
	-A neutron-openvswi-sg-chain -m physdev --physdev-in tapb079c24c-83 --physdev-is-bridged -j neutron-openvswi-ob079c24c-8 

Entre las que destacamos las siguientes:

* Se crean tres nuevas cadenas, para los procesos de entrada (i), salida (o) y prevenir spoofing (s):

	-N neutron-openvswi-ib079c24c-8
	-N neutron-openvswi-ob079c24c-8
	-N neutron-openvswi-sb079c24c-8

* Se permiten conexiones entrantes relacionadas o establecidas:

	-A neutron-openvswi-ib079c24c-8 -m state --state RELATED,ESTABLISHED -j RETURN 

* Se permiten las respuestas DHCP (DHCPOFFER y DHCPACK) desde el servidor DHCP de la red:

	-A neutron-openvswi-ib079c24c-8 -s 10.0.0.3/32 -p udp -m udp --sport 67 --dport 68 -j RETURN 

* Se permiten peticiones DHCP (DHCPDISCOVER y DHCPREQUEST):

	-A neutron-openvswi-ob079c24c-8 -p udp -m udp --sport 68 --dport 67 -j RETURN 

* Se permiten conexiones salientes relacionadas o establecidas:

	-A neutron-openvswi-ob079c24c-8 -m state --state RELATED,ESTABLISHED -j RETURN 

* Se verifica la correspondencia entre la dirección IP y la MAC:

	-A neutron-openvswi-sb079c24c-8 -s 10.0.0.2/32 -m mac --mac-source FA:16:3E:79:3B:AC -j RETURN 

#### Conectividad entre las instancias de la misma red

Como las reglas de cortafuegos se aplican a las instancias de forma individual,
inicialmente no tienen acceso a servicios de otra instancia que se ejecute
dentro de la misma red, como cabría esperar. 


en principio no puedenLas instancias que están en la misma red local, tienen diferentes reglas de
cortafuegos aplicadas, por lo que en principio no están conectadas. 

Las reglas de seguridad que tenemos ahora mismo son:

	$ neutron security-group-rule-list 
	+--------------------------------------+----------------+-----------+----------+------------------+--------------+
	| id                                   | security_group | direction | protocol | remote_ip_prefix | remote_group |
	+--------------------------------------+----------------+-----------+----------+------------------+--------------+
	| 5b611bbc-3422-4b81-beb0-0e935b2e88fe | default        | egress    | icmp     |                  |              |
	| 6a218f81-7489-49e8-9b7d-808e24ac4c1d | default        | egress    | udp      | 0.0.0.0/0        |              |
	| b65cf8d8-9b3b-4922-9a1e-14ac734cca9e | default        | egress    | tcp      |                  |              |
	| e69a343a-3304-4ba1-ac3d-ae7208aad0d5 | default        | ingress   | icmp     | 0.0.0.0/0        |              |
	+--------------------------------------+----------------+-----------+----------+------------------+--------------+

Las que vienen por defecto más el ping desde cualquier sitio (fuera o dentro), por lo que 
las máquinas hacen ping entre sí, pero no se puede acceder a ningún puerto tcp o udp.

##### Reglas de cortafuegos para la conectividad interna

Si queremos que las instancias puedan conectarse a algún servicio de otra instancia
 de la misma red, hay que agregar una regla al grupo de seguridad que se esté utilizando,
a menos de que haya una regla más general que ya lo permita. Vamos a añadir como ejemplo
una regla de acceso por ssh desde 10.0.0.0/24

	$ neutron security-group-rule-create --direction ingress --protocol tcp --port-range-min 22 --port-range-max 22 --remote-ip-prefix 10.0.0.0/24 default

Y ya podemos acceder por ssh entre las instancias

¿Qué aparece en iptables del nodo de computación?

	# iptables -S
	...
	-A neutron-openvswi-i6a6ac39c-6 -s 10.0.0.0/24 -p tcp -m tcp --dport 22 -j RETURN 
	-A neutron-openvswi-ib079c24c-8 -s 10.0.0.0/24 -p tcp -m tcp --dport 22 -j RETURN
	...

