---
layout: presentacion
title: Implantación de la infraestructura de prueba OpenStack. Devstack
tema: solarized
---

	<section>
	    <h2>Entorno de pruebas para  OpenStack</h2>
	    <h3>Devstack</h3>
	    
	    <p>
	      <small><a href="http://albertomolina.wordpress.com">Alberto Molina
	      Coballes</a> / <a
	      href="http://twitter.com/alberto_molina">@alberto_molina</a> y <a
	      href="http://josedomingo.org">José Domingo Muñoz
	      Rodríguez</a> / <a
	      href="http://twitter.com/Pledin_JD">@Pledin_JD</a> </small>
	    </p>
	    <p><small>
		<a href="http://creativecommons.org/licenses/by-sa/3.0/"><img src="../../img/cc_by_sa.png"
		width="100px" border="0"/></a></small></p>
	  </section>

	  <section>
 	      <h2>Objetivo</h2>
	       <p>DevStack es un conjunto de scripts en bash que nos permiten instalar OpenStack de forma automática. Tenemos varias formas de realizar la instalación:</p>
	       <ul>
			<li>En una máquina física</li>
			<li>En una máquina virtual</li>
	       </ul>
	       
		   
	  </section>
	  <section>
	   	<section>
			<h2>Instalación en una máquina virtual</h2>
		</section>
		<section>
			<h3>¿Qué necesito?</h3>
			<ul>
				<li>Equipo necesario: RAM 3GB y procesador VT-x/AMD-v</li>
				<li>Git instalado</li>
				<li>Virtualbox instalado (versión de debian wheezy 4.1.18) </li>
				<li>Vagrant instalado (1.5.1)</li>
				<li>Box precise64</li>
				<li>Ansible instalado</li>
			</ul>
		</section>
		<section>
		<pre><code>
; Como root
# apt-get install git

# apt-get install virtualbox

# wget https://dl.bintray.com/mitchellh/vagrant/vagrant_1.4.3_x86_64.deb
# dpkg -i vagrant_1.4.3_x86_64.deb


# apt-get install python-pip python-dev
# pip install ansible

; Como usuario sin privilegio nos bajamos el box precise64
$ vagrant box add precise64 http://files.vagrantup.com/precise64.box
		</code></pre>
		</section>
		<section>
			<h3>Realizando la instalación</h3>
			<pre><code>
$ git clone https://github.com/iesgn/devstack-havana-cursocloud
$ cd devstack-havana-cursocloud/MV
$ chmod 0600 id_vagrant
$ vagrant up
		        </code></pre>
			<ul>
				<li>Arranca una máquina virtual Ubuntu 12.04</li>
				<li>Clona el repositorio devstack dentro de la máquina</li>
				<li>Instala el devstack (versión havana) en la máquina (stack.sh)</li>
			</ul>
			<small>La máquina virtual tiene 4 Gb de RAM si quieres cambiarlo, antes de ejecutar la intalación, modifica el fichero Vagrantfile:</small>
			<pre><code>
vb.customize ["modifyvm", :id, "--memory", 4096]		
		        </code></pre>
			<h3>¡¡¡ Nos tomamos un cafe!!!</h3>

		  </section>
		  <section>
			<h3>Accediendo a OpenStack</h3>
			<ul>
				<li>http://192.168.27.100</li>
				<li>Usuario de prueba: <strong>demo</strong> con contraseña <strong>devstack</strong>. </li>
				<li>Usuario <strong>admin</strong> con contraseña <strong>devstack</strong>. </li>
				<li>Credenciales en la máquina virtual:</li>
				<ul>
					<li><pre>source openrc demo demo</pre></li>
					<li><pre>source openrc admin admin</pre></li>
				</ul>
				<li>Credenciales en en el host:</li>
				<ul>
					<li><pre>source demo.openrc</pre></li>
					<li><pre>source admin.openrc</pre></li>
				</ul>

			</ul>
		  </section>
		  <section>
			<h3>¿Las instancias tienen internet?</h3>
			<p>Por defecto las instancias no tienen acceso a internet. Si queremos tener esta funcionalidad hay que configurar la máquina host para que haga NAT, para ello como root ejecuta:</p>
			<pre><code>
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
		       </code></pre>
		       <small>Modifica eth0 por la interfaz de red conectada a internet (por ejemplo si tienes WIFI será wlan0).</small>
		  </section>
		  <section>
			<h3>Al terminar de trabajar...</h3>
			<p>Una vez que hemos terminado de trabajar con OpenStack y antes de apagar nuestra máquina virtual, debemos parar los servicios:</p>
			<pre><code>
$ cd devstack-havana-cursocloud/MV
$ vagrant ssh

$ cd devstack
$ ./unstack.sh
		       </code></pre>
			<p>Cuando queramos seguir trabajando, encendemos la máquina y ejecutamos:</p>
			<pre><code>
$ cd devstack-havana-cursocloud/MV
$ vagrant ssh

$ cd devstack
$ kpartx -va /opt/stack/data/stack-volumes-backing-file
$ source openrc functions
$ ./rejoin-stack.sh &
			</code></pre>
		  </section>
		  <section>
			<h3>Y si algo falla...</h3>
			<p>Si algo no funciona, podemos reiniciar nuestro OpenStack: tardará menos que la inslación inicial y se perderan todos los datos (instancias, volúmenes, imágenes,...):</p>
			<pre><code>
$ cd devstack-havana-cursocloud/MV
$ vagrant ssh

$ cd devstack
$ ./stack.sh
			</code></pre>

		  </section>
	
	  </section>
	  <section>
	   	<section>
			<h2>Instalación en una máquina física</h2>
		</section>
		<section>
			<h3>¿Qué necesito?</h3>
			<ul>
				<li>Equipo necesario: RAM 2Gb y procesador VT-x/AMD-v</li>
				<li>Git instalado</li>
			</ul>
			<pre><code>
; Como root
# apt-get install git
			</code></pre>
		</section>
		
		<section>
			<h3>Realizando la instalación</h3>
			<pre><code>
$ git clone https://github.com/iesgn/devstack-havana-cursocloud
$ cd devstack-havana-cursocloud/MF
$ chmod 755 instalar.sh
$ ./instalar.sh
		        </code></pre>
			<ul>
				<li>Clona el repositorio devstack dentro de la máquina</li>
				<li>Instala el devstack (versión havana) en la máquina (stack.sh)</li>
			</ul>
			<h3>¡¡¡ Nos tomamos un cafe!!!</h3>

		  </section>
		  <section>
			<h3>Accediendo a OpenStack</h3>
			<ul>
				<li>http://localhost</li>
				<li>Usuario de prueba: <strong>demo</strong> con contraseña <strong>devstack</strong>. </li>
				<li>Usuario <strong>admin</strong> con contraseña <strong>devstack</strong>. </li>
				<li>Credenciales en el directorio devstcak:</li>
				<ul>
					<li><pre>source openrc demo demo</pre></li>
					<li><pre>source openrc admin admin</pre></li>
				</ul>

			</ul>
		  </section>
		  <section>
			<h3>¿Las instancias tienen internet?</h3>
			<p>Por defecto las instancias no tienen acceso a internet. Si queremos tener esta funcionalidad hay que configurar la máquina host para que haga NAT, para ello como root ejecuta:</p>
			<pre><code>
echo 1 > /proc/sys/net/ipv4/ip_forward
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
		       </code></pre>
			<small>Modifica eth0 por la interfaz de red conectada a internet (por ejemplo si tienes WIFI será wlan0).</small>

		  </section>
		  <section>
			<h3>Al terminar de trabajar...</h3>
			<p>Una vez que hemos terminado de trabajar con OpenStack y antes de apagar nuestra máquina virtual, debemos parar los servicios:</p>
			<pre><code>
$ cd devstack
$ ./unstack.sh
		       </code></pre>
			<p>Cuando queramos seguir trabajando, encendemos la máquina y ejecutamos:</p>
			<pre><code>
$ cd devstack
$ kpartx -va /opt/stack/data/stack-volumes-backing-file
$ source openrc functions
$ ./rejoin-stack.sh &
			</code></pre>
		  </section>
		  <section>
			<h3>Y si algo falla...</h3>
			<p>Si algo no funciona, podemos reiniciar nuestro OpenStack: tardará menos que la inslación inicial y se perderan todos los datos (instancias, volúmenes, imágenes,...):</p>
			<pre><code>
$ cd devstack
$ ./stack.sh
			</code></pre>

		  </section>
	</section>
	<section>
		<h2>Los siguientes pasos...</h2>
			<ul>
			<li>Crear sabores personales (por ejemplo, m1.enano con 256 Mb de RAM, otro m1.amedida con el parámetro "disco raíz" a 0). Esa operación la hacemos con el usuario admin.</li>
			<li>Bajarnos una imagen de Ubuntu 12.04 y subirla al cloud (apartado Imágenes)</li>
			<pre>http://cloud-images.ubuntu.com/precise/current/precise-server-cloudimg-armhf-disk1.img</pre>
			<li>El usuario demo debe trabajar en el proyecto "demo", no en uno que se llama "invisible_to_admin"</li>
			<li>Las reglas de seguridad que vienen definidas parecen que no funcionan. Crear al menos las dos siguientes:</li>
			<ul>
				<li>Para hacer ping, una regla del tipo "ALL ICMP"</li>
				<li>Para acceder por ssh, una regla del tipo SSH</li>
			</ul>
			<li>Las instancias deben tener conexión a internet, pero el servidor DNS habrá que modificarlo para resolver nombres</li>

	</section>
	<section>
		<h2>Ejercicio</h2>
		<ol>
			<li>Modifica las reglas de seguridad como se ha explicado anteriormente</li>
			<li>Crea una instancia a partir de la imagen cirros</li>
			<li>Asígnale una ip flotante</li>
			<li>Comprueba que se le puede hacer ping</li>
			<li>Comprueba que se puede acceder por ssh. Usuario: cirros, password: cubswin:)</li>
			<li>Una vez has accedido a la instancia comprueba que tiene internet (ping 8.8.8.8)</li>
		</ol>
	</section>
	  
	 

